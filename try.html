<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>FCM HTTP v1 + Cloudflare KV Push Demo</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 24px auto; padding: 12px; }
    button { margin: 6px; padding: 10px 14px; }
    pre { background: #f3f3f3; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Push demo â€” FCM HTTP v1 + Cloudflare</h2>
  <button id="enable">Register & Get Token</button>
  <button id="save">Save Token to KV</button>
  <button id="send">Send Notification (from KV)</button>
  <pre id="out"></pre>

<script>
const log = msg => { document.getElementById('out').textContent += msg + "\n"; };

// ---------- Replace these ----------
const firebaseConfig = {
  apiKey: "AIzaSyDtZnYYDb5TR01G6zsCtrF0HBR6pnQ2Beg",
    authDomain: "general-68ca7.firebaseapp.com",
    projectId: "general-68ca7",
    storageBucket: "general-68ca7.firebasestorage.app",
    messagingSenderId: "674522865143",
    appId: "1:674522865143:web:c4ec47f2e370c33c3ca2f2"
};
const VAPID_KEY = "BBq9RZXnJDZb9Jq9PDt5YHoKWqgyfy1VhXaV_kfMqXOakh5zMUlqFuGKUVRig9qC8F_F4qMujROAboHXNDbh3hc"; 
const WORKER_URL = "https://fancy-poetry-027f.nafil-8895-s.workers.dev"; 
// -------------------------------------

firebase.initializeApp(firebaseConfig);
const messaging = firebase.messaging();
let lastToken = null;

// Register SW, request permission, and get token
async function registerAndGetToken() {
  if (!('serviceWorker' in navigator)) {
    log('âŒ Service Worker not supported');
    return;
  }
  try {
    // Register the messaging service worker
    const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
    log('âœ… Service worker registered');

    // Ask user permission for notifications
    const perm = await Notification.requestPermission();
    log('ðŸ”” Notification permission: ' + perm);
    if (perm !== 'granted') return;

    // Get the FCM token
    lastToken = await messaging.getToken({
      vapidKey: VAPID_KEY,
      serviceWorkerRegistration: registration
    });

    if (lastToken) {
      log('ðŸŽ¯ FCM token:\n' + lastToken);
    } else {
      log('âš ï¸ Failed to get token');
    }
  } catch (e) {
    log('âŒ Error: ' + e.message);
  }
}

// Save token to KV via backend Worker
async function saveToken() {
  if (!lastToken) {
    log('âš ï¸ No token found. Click "Register" first.');
    return;
  }
  try {
    const r = await fetch(WORKER_URL + '/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: lastToken })
    });
    log('ðŸ’¾ Save response: ' + r.status + ' â€” ' + await r.text());
  } catch (err) {
    log('âŒ Save error: ' + err.message);
  }
}

// Trigger a push from your Worker
async function sendNotification() {
  try {
    const r = await fetch(WORKER_URL + '/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: 'Hello from KV',
        body: 'Sent via Cloudflare Worker + FCM HTTP v1'
      })
    });
    log('ðŸ“¤ Send response: ' + r.status + ' â€” ' + await r.text());
  } catch (err) {
    log('âŒ Send error: ' + err.message);
  }
}

document.getElementById('enable').addEventListener('click', registerAndGetToken);
document.getElementById('save').addEventListener('click', saveToken);
document.getElementById('send').addEventListener('click', sendNotification);

// Foreground messages
messaging.onMessage(async payload => {
  log('ðŸ’¬ Foreground message: ' + JSON.stringify(payload));

  // Show the notification via the service worker even in foreground
  if (payload.notification && navigator.serviceWorker) {
    const reg = await navigator.serviceWorker.getRegistration();
    if (reg) {
      reg.showNotification(payload.notification.title, {
        body: payload.notification.body,
        icon: payload.notification.icon || '/icon.png',
        data: payload.data || {}
      });
    }
  }
});

</script>
</body>
</html>

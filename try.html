<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>FCM Push with Cloudflare Worker Backend</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
    button { padding: 12px 24px; font-size: 18px; margin: 10px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Push Notifications Demo (FCM + Cloudflare Worker)</h1>
  <button id="subscribeBtn">Subscribe & Save Token</button>
  <button id="triggerBtn">Trigger Push</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging.js";

    // Your Firebase config - replace placeholders with your Firebase project config
    const firebaseConfig = {
    apiKey: "AIzaSyDtZnYYDb5TR01G6zsCtrF0HBR6pnQ2Beg",
    authDomain: "general-68ca7.firebaseapp.com",
    projectId: "general-68ca7",
    storageBucket: "general-68ca7.firebasestorage.app",
    messagingSenderId: "674522865143",
    appId: "1:674522865143:web:c4ec47f2e370c33c3ca2f2",
    measurementId: "G-6L0DXHGCBE"
  };

    // Initialize Firebase app
    const app = initializeApp(firebaseConfig);
    const messaging = getMessaging(app);

    // Your Web Push public VAPID key from Firebase Console
    const publicVapidKey = "BL6h9NFc_O5r-l5JJ6wKpvzuHrI6o76uSTCM7j2KDG_r_Gp2X07QWBnLMak3bwEu2WD6Wbr7H2qyrtBfCNhbN2Q";

    // Your backend Cloudflare Worker URL for storing tokens and triggering notifications
    // Replace this with your Worker 'workers.dev' temporary address or routed URL
    // Example workers.dev address for a Worker named "my-worker" in account "myacct":
    // https://my-worker.myacct.workers.dev/fcmpush
    // If Worker is routed to your domain, use that domain URL + path instead
    const backendUrl = "https://fancy-poetry-027f.nafil-8895-s.workers.dev/fcmpush";

    // Subscribe user and send FCM token to Cloudflare Worker backend
    async function subscribeUser() {
      const permission = await Notification.requestPermission();
      if (permission !== "granted") {
        alert("Notification permission denied by user.");
        return;
      }
      try {
        const currentToken = await getToken(messaging, { vapidKey: publicVapidKey });
        if (!currentToken) {
          alert("No token retrieved.");
          return;
        }
        const res = await fetch(backendUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "save", token: currentToken })
        });
        alert(res.ok ? "Token saved to backend!" : "Failed to save token.");
      } catch (err) {
        console.error("Failed to get token or save:", err);
        alert("Error: " + err.message);
      }
    }

    // Trigger push notifications via backend Worker
    async function triggerPush() {
      try {
        const res = await fetch(backendUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "trigger" })
        });
        alert(res.ok ? "Push triggered!" : "Failed to trigger push.");
      } catch (err) {
        console.error("Trigger error:", err);
        alert("Error triggering push: " + err.message);
      }
    }

    // Handle foreground messages (when the page is open)
    onMessage(messaging, (payload) => {
      alert(`Foreground notification:\n${payload.notification.title}\n${payload.notification.body}`);
    });

    // UI button event listeners
    document.getElementById("subscribeBtn").addEventListener("click", subscribeUser);
    document.getElementById("triggerBtn").addEventListener("click", triggerPush);

    // Register the service worker for messaging (make sure /firebase-messaging-sw.js is hosted on your site root)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/firebase-messaging-sw.js")
        .then(registration => {
          console.log("Service Worker registered for Firebase Messaging.");
        })
        .catch(err => {
          console.error("Service Worker registration failed:", err);
        });
    }
  </script>
</body>
</html>

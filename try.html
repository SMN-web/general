<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Push Test</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
  button { padding: 12px 24px; font-size: 18px; margin: 10px; cursor: pointer; }
</style>
</head>
<body>

<h1>Push Notification Demo</h1>
<button id="saveBtn">Subscribe (Save)</button>
<button id="deleteBtn">Unsubscribe (Delete)</button>
<button id="triggerBtn">Trigger Push</button>

<script>
const publicVapidKey = "YOUR_PUBLIC_VAPID_KEY"; // Replace

function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
}

async function registerSW() {
  return await navigator.serviceWorker.register("/service-worker.js");
}

document.getElementById("saveBtn").onclick = async () => {
  const perm = await Notification.requestPermission();
  if (perm !== "granted") return alert("Permission denied");

  const reg = await registerSW();
  const subscription = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
  });

  const res = await fetch("https://fancy-poetry-027f.nafil-8895-s.workers.dev/push", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "save", subscription })
  });
  alert(res.ok ? "Subscribed & saved!" : "Failed to save subscription");
};

document.getElementById("deleteBtn").onclick = async () => {
  const reg = await navigator.serviceWorker.ready;
  const subscription = await reg.pushManager.getSubscription();
  if (!subscription) return alert("No subscription to delete");
  await subscription.unsubscribe();
  await fetch("https://fancy-poetry-027f.nafil-8895-s.workers.dev/push", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "delete", subscription })
  });
  alert("Subscription deleted");
};

document.getElementById("triggerBtn").onclick = async () => {
  const res = await fetch("https://fancy-poetry-027f.nafil-8895-s.workers.dev/push", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "trigger" })
  });
  alert(res.ok ? "Push triggered!" : "Push trigger failed");
};
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FCM Push Notification Test</title>
</head>
<body>
  <h1>FCM Push Notification Demo</h1>

  <button id="getTokenBtn">Get & Save FCM Token</button>
  <button id="sendNotificationBtn">Send Notification (Saved Token)</button>

  <p id="status"></p>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

  <script>
    const firebaseConfig = {
      // YOUR FIREBASE CONFIG HERE
      apiKey: "AIzaSyDtZnYYDb5TR01G6zsCtrF0HBR6pnQ2Beg",
    authDomain: "general-68ca7.firebaseapp.com",
    projectId: "general-68ca7",
    storageBucket: "general-68ca7.firebasestorage.app",
    messagingSenderId: "674522865143",
    appId: "1:674522865143:web:c4ec47f2e370c33c3ca2f2"
    };

    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    const backendUrl = "https://fancy-poetry-027f.nafil-8895-s.workers.dev";

    async function getTokenAndSave() {
      try {
        const statusEl = document.getElementById("status");
        statusEl.textContent = "Requesting notification permission...";
        await Notification.requestPermission();
        if (Notification.permission !== "granted") {
          statusEl.textContent = "Notification permission denied";
          return;
        }

        statusEl.textContent = "Getting FCM token...";
        const token = await messaging.getToken({ vapidKey: "BBq9RZXnJDZb9Jq9PDt5YHoKWqgyfy1VhXaV_kfMqXOakh5zMUlqFuGKUVRig9qC8F_F4qMujROAboHXNDbh3hc" });
        statusEl.textContent = "FCM Token: " + token;

        // Save token to backend KV
        const res = await fetch(backendUrl + "/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token })
        });
        statusEl.textContent += "\nSave response: " + (await res.text());
      } catch (e) {
        alert("Error getting token: " + e.message);
      }
    }

    async function sendNotification() {
      try {
        const res = await fetch(backendUrl + "/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: "Hello from Web",
            body: "This is a test notification."
          })
        });
        const text = await res.text();
        alert("Send response:\n" + text);
      } catch (e) {
        alert("Error sending notification: " + e.message);
      }
    }

    document.getElementById("getTokenBtn").onclick = getTokenAndSave;
    document.getElementById("sendNotificationBtn").onclick = sendNotification;

    // Register service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./firebase-messaging-sw.js")
        .then(() => console.log("Service worker registered"))
        .catch(console.error);
    }
  </script>
</body>
</html>
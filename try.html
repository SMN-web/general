<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>FCM HTTP v1 + Cloudflare KV Push Demo</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 24px auto; padding: 12px; }
    button { margin: 6px; padding: 10px 14px; }
    pre { background: #f3f3f3; padding: 10px; }
  </style>
</head>
<body>
  <h2>Push demo — FCM HTTP v1 + Cloudflare KV</h2>
  <button id="enable">Register & Get Token</button>
  <button id="save">Save Token to KV</button>
  <button id="send">Send Notification (from KV)</button>
  <pre id="out"></pre>

<script>
const log = msg => { document.getElementById('out').textContent += msg + "\n"; };

// ---------- Replace these ----------
const firebaseConfig = {
  apiKey: "AIzaSyDtZnYYDb5TR01G6zsCtrF0HBR6pnQ2Beg",
    authDomain: "general-68ca7.firebaseapp.com",
    projectId: "general-68ca7",
    storageBucket: "general-68ca7.firebasestorage.app",
    messagingSenderId: "674522865143",
    appId: "1:674522865143:web:c4ec47f2e370c33c3ca2f2"
};
const VAPID_KEY = "BBq9RZXnJDZb9Jq9PDt5YHoKWqgyfy1VhXaV_kfMqXOakh5zMUlqFuGKUVRig9qC8F_F4qMujROAboHXNDbh3hc"; // from Firebase Console → Cloud Messaging
const WORKER_URL = "https://fancy-poetry-027f.nafil-8895-s.workers.dev"; // Worker backend
// -------------------------------------

firebase.initializeApp(firebaseConfig);
const messaging = firebase.messaging();
let lastToken = null;

async function registerAndGetToken() {
  if (!('serviceWorker' in navigator)) {
    log('Service Worker not supported'); return;
  }
  try {
    const reg = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
    messaging.useServiceWorker(reg);
    log('Service worker registered');

    const perm = await Notification.requestPermission();
    log('Notification permission: ' + perm);
    if (perm !== 'granted') return;

    lastToken = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
    log('FCM token:\n' + lastToken);
  } catch (e) {
    log('Error: ' + e.message);
  }
}

document.getElementById('enable').addEventListener('click', registerAndGetToken);

document.getElementById('save').addEventListener('click', async () => {
  if (!lastToken) { log('No token. Click Register first.'); return; }
  const r = await fetch(WORKER_URL + '/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token: lastToken })
  });
  log('Save response: ' + r.status + ' — ' + await r.text());
});

document.getElementById('send').addEventListener('click', async () => {
  const r = await fetch(WORKER_URL + '/send', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title: 'Hello from KV', body: 'Sent via Cloudflare Worker + FCM HTTP v1' })
  });
  log('Send response: ' + r.status + ' — ' + await r.text());
});

// Foreground
messaging.onMessage(payload => {
  log('Foreground message: ' + JSON.stringify(payload));
  if (payload.notification) {
    new Notification(payload.notification.title, {
      body: payload.notification.body,
      icon: payload.notification.icon
    });
  }
});
</script>
</body>
</html>
